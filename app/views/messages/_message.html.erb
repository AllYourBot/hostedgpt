<%# locals: (message:, scroll_into_view: nil, request_id: nil, message_counter: -1) -%>
<%# request_id is not used, but broadcasting turbo stream messages provides it as a local so it needs to be accepted %>

<% max_index = message.conversation.messages.length - 1 %>
<% last_message = message_counter == max_index %>

<div
  id="<%= dom_id message %>"
  class="ml-9 sm:ml-3 md:ml-8 mb-5 group"
  data-role="message"
  data-controller="conversation-message"
  data-conversation-message-scroll-into-view-value="<%= scroll_into_view.nil? ? last_message : scroll_into_view %>"
  >
  <div class="flex">
    <div class="w-6 flex flex-col items-center ml-1">
      <div class="w-6 h-6 bg-black dark:bg-white rounded-full mt-1"></div>
    </div>

    <!-- Right Column -->
    <div data-controller="clipboard" class="flex-1 min-w-0 ml-3 mr-8 text-black dark:text-zinc-200 text-base">
      <div class="mt-1 font-semibold" data-role="role">
        <%= message.user? ? 'You' : message.conversation.assistant.name %>
      </div>

      <% if message.documents.present? && message.documents.first.file.attached? %>
        <%= image_tag message.documents.first.file, class: "w-full h-auto border-2 border-zinc-100 rounded-md" %>
      <% end %>

      <%# This div needs to be tightly wrapped around the content_text output because the whitespace formatting is important. %>
      <div class="text-zinc-700 dark:text-white whitespace-pre-wrap" data-role="content_text" data-clipboard-target="text"><%= message.content_text %></div>

      <div class="mt-2 flex justify-start gap-2 text-zinc-500 dark:text-zinc-400 invisible group-hover:visible">
        <% if message.user? %>
          <%= icon "pencil", variant: :outline, size: 18, class: 'hover:text-zinc-900 dark:hover:text-white cursor-pointer stroke-2', title: "Edit" %>
        <% else %>
          <%= icon "clipboard", data: { :action => "click->clipboard#copy", tip: "Copy" }, variant: :outline, size: 18, class: 'hover:text-zinc-900 dark:hover:text-white cursor-pointer stroke-2', title: "Copy" %>
          <%= icon "arrow-path", variant: :outline, size: 18, class: 'hover:text-zinc-900 dark:hover:text-white cursor-pointer stroke-2', title: "Regenerate" %>
        <% end %>
      </div>
    </div>
  </div>
</div>
