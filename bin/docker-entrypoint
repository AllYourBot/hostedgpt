#!/bin/sh -e

# If running the rails server then create or migrate existing database
if echo "${1}" | grep -q "rails$" && [ "${2}" == "server" ]; then
  rm -f ./tmp/pids/server.pid 2>/dev/null
  echo "Running bundle"
  bundle
  echo "Running db:prepare"
  ./bin/rails db:prepare
elif echo "${1}" | grep -q "rails$" && [ "${2}" == "test" ]; then
  export RAILS_ENV=test
  echo "Running bundle"
  bundle
  echo "Running db:prepare"
  ./bin/rails db:prepare
else
  echo "Running bundle"
  bundle
  echo "Skipping db:prepare"
fi

if [ "${1}" == "psql" ]; then
  echo "Running psql to connect to development database"
  exec psql -d "$DATABASE_URL"
fi

exec "${@}"
